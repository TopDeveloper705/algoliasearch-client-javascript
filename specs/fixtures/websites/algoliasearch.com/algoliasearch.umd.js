!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("@algolia/client-common")):"function"==typeof define&&define.amd?define(["@algolia/client-common"],t):(e=e||self).main=t(e.clientCommon)}(this,(function(e){"use strict";function t(){let e={};return{get(t,s,r){const a=JSON.stringify(t);if(a in e)return Promise.resolve(e[a]);const n=s(),i=r&&r.miss||(()=>Promise.resolve());return n.then(e=>i(e)).then(()=>n)},set:(t,s)=>(e[JSON.stringify(t)]=s,Promise.resolve(s)),delete:t=>(delete e[JSON.stringify(t)],Promise.resolve()),clear:()=>(e={},Promise.resolve())}}const s={Debug:1,Info:2,Error:3};const r={WithinQueryParameters:0,WithinHeaders:1};function a(e,t){return void 0!==t&&void 0!==t.methods&&t.methods.forEach(t=>{Object.assign(e,t(e))}),e}function n(e,...t){let s=0;return e.replace(/%s/g,()=>encodeURIComponent(t[s++]))}function i(e){return`${Object.keys(e).map(t=>n("%s=%s",t,e[t])).join("&")}`}function o(e,t,s){const r=(a=s,`${Object.keys(a).map(e=>n("%s=%s",e,a[e])).join("&")}`);var a;let i=`https://${e.url}/${t}`;return r.length&&(i+=`?${r}`),i}function h(e,t){const s=Array.isArray(e.data)?e.data:{...e.data,...t.data};return s.constructor===Object&&0===Object.entries(s).length?"":JSON.stringify(s)}const u=(e,t,s)=>(e=>{const t=e.status;return e.isTimedOut||(({isTimedOut:e,status:t})=>!e&&0==~~t)(e)||2!=~~(t/100)&&4!=~~(t/100)})(t)?(t.isTimedOut||e.setAsDown(),s.retry()):(({status:e})=>2==~~(e/100))(t)?s.success():s.fail();function d(e,t,s,r){let a=0;return Promise.all(t.map(t=>e.hostsCache.get({url:t.url},()=>Promise.resolve(t)).then(e=>{t.downDate=e.downDate,t.up=e.up}))).then(()=>{t=t.filter(e=>e.isUp()).reverse();const n=i=>{if(void 0===i)throw{name:"RetryError",message:"Unreachable hosts - your application id may be incorrect. If the error persists, contact support@algolia.com."};return e.requester.send({data:h(s,r),headers:{...e.headers,...r.headers},method:s.method,url:o(i,s.path,{...e.queryParameters,...r.queryParameters,"x-algolia-agent":e.userAgent.value}),timeout:(a+1)*(r.timeout?r.timeout:0)}).then(r=>u(i,r,{success:()=>(function({content:e}){return JSON.parse(e)})(r),retry:()=>(e.logger.debug("Retryable failure",{request:s,response:r,host:i,triesLeft:t.length,timeoutRetries:a}),r.isTimedOut&&a++,e.hostsCache.set({url:i.url},i).then(()=>n(t.pop()))),fail:()=>{throw function({content:e,status:t}){let s=e;try{s=JSON.parse(e).message}catch(e){}return function(e,t){return{name:"ApiError",message:e,status:t}}(s,t)}(r)}}))};return n(t.pop())})}function c(e,t){const s=void 0===e?{}:e,r={};return Object.keys(s).forEach(e=>{["timeout","headers","queryParameters","data","cacheable"].includes(e)||(r[e]=s[e])}),{data:r,timeout:void 0===s.timeout?t:s.timeout,headers:void 0===s.headers?{}:s.headers,queryParameters:void 0===s.queryParameters?{}:s.queryParameters,cacheable:s.cacheable}}function l(e,t,s){if(void 0!==e&&t in e){const s=e[t];return delete e[t],s}return s}const m={Read:1,Write:2,Any:3};function p(e){return{...e,headers:{},queryParameters:{},hosts:[],addUserAgent(t,s){this.userAgent=e.userAgent.with({segment:t,version:s})},addHeaders(e){Object.assign(this.headers,e)},addQueryParameters(e){Object.assign(this.queryParameters,e)},setHosts(e){this.hosts=e.map(e=>(function(e,t){return{url:e,accept:t,downDate:0,up:!0,setAsDown(){this.downDate=Date.now(),this.up=!1},isUp(){return!this.up&&Date.now()-this.downDate>3e3&&(this.up=!0),this.up}}})(e.url,e.accept))},read(e,t){const s=c(t,this.timeouts.read),r={request:e,mappedRequestOptions:s},a=()=>d(this,this.hosts.filter(e=>0!=(e.accept&m.Read)),e,s);return!0!==(void 0!==s.cacheable?s.cacheable:e.cacheable)?a():this.responsesCache.get(r,()=>this.requestsCache.get(r,()=>this.requestsCache.set(r,a()).then(e=>this.requestsCache.delete(r).then(()=>e))),{miss:e=>this.responsesCache.set(r,e)})},write(e,t){return d(this,this.hosts.filter(e=>0!=(e.accept&m.Write)),e,c(t,this.timeouts.write))}}}const y="DELETE",g="GET",b="POST",f="PUT";const x=e=>{const t=e.appId,s=p(e);s.setHosts([{url:`${t}-dsn.algolia.net`,accept:m.Read},{url:`${t}.algolia.net`,accept:m.Write}].concat(function(e){let t=e.length-1;for(;t>0;t--){const s=Math.floor(Math.random()*(t+1)),r=e[t];e[t]=e[s],e[s]=r}return e}([{url:`${t}-1.algolianet.com`,accept:m.Any},{url:`${t}-2.algolianet.com`,accept:m.Any},{url:`${t}-3.algolianet.com`,accept:m.Any}])));const n=function(e,t,s){const a={"x-algolia-api-key":s,"x-algolia-application-id":t};return{headers:()=>e===r.WithinHeaders?a:{},queryParameters:()=>e===r.WithinQueryParameters?a:{}}}(void 0!==e.authMode?e.authMode:r.WithinHeaders,t,e.apiKey);return s.addHeaders({...n.headers(),"content-type":"application/x-www-form-urlencoded"}),s.addQueryParameters(n.queryParameters()),a({transporter:s,appId:t,addAlgoliaAgent(e,t){s.addUserAgent(e,t)}},e)};function w(e){let t=(e,t)=>Promise.resolve();return Object.assign(e,{onWait:s=>(t=s,e),wait:s=>w(e.then(e=>t(e,s).then(()=>e)))})}const I=e=>({...e,getTask(e,t){return this.transporter.read({method:g,path:n("1/indexes/%s/task/%s",this.indexName,e.toString())},t)}}),v=e=>({...I(e),waitTask(e,t){let s=0;return this.getTask(e,t).then(r=>"published"!==r.status?(s++,new Promise(r=>{setTimeout(()=>{r(this.waitTask(e,t))},Math.min(100*s,1e3))})):r)}}),k=e=>({...e,initIndex(e,t){return a({transporter:this.transporter,indexName:e},t)}}),O=e=>({...e,copyIndex(e,t,s){return w(this.transporter.write({method:b,path:n("1/indexes/%s/operation",e),data:{operation:"copy",destination:t}},s)).onWait((t,s)=>k(this).initIndex(e,{methods:[v]}).waitTask(t.taskID,s))}}),j="settings",P="synonyms",D=e=>({...e,searchForFacetValues(e,t,s){return this.transporter.read({method:b,path:n("1/indexes/%s/facets/%s/query",this.indexName,e),data:{facetQuery:t},cacheable:!0},s)}}),N=e=>({...v(e),chunk(e,t,s){const r=l(s,"batchSize",1e3),a=[],n=(i=0)=>{const o=[];let h;for(h=i;h<e.length&&(o.push(e[h]),o.length!==r);h++);return 0===o.length?Promise.resolve(a):this.batch(o.map(e=>({action:t,body:e})),s).then(e=>(a.push(e),n(++h)))};return w(n()).onWait((e,t)=>Promise.all(e.map(e=>this.waitTask(e.taskID,t))))},batch(e,t){return w(this.transporter.write({method:b,path:n("1/indexes/%s/batch",this.indexName),data:{requests:e}},t)).onWait((e,t)=>this.waitTask(e.taskID,t))}});function T(e){return new Promise(t=>{const s={page:0},r=()=>e.request(s).then(a=>(void 0!==e.batch&&e.batch(a.hits),e.shouldStop(a)?t():(s.page++,r())));return r()})}const q=e=>({...e,searchRules(e,t){return this.transporter.read({method:b,path:n("1/indexes/%s/rules/search",this.indexName),data:{query:e}},t)}}),S=e=>({...e,searchSynonyms(e,t){return this.transporter.read({method:b,path:n("1/indexes/%s/synonyms/search",this.indexName),data:{query:e}},t)}}),A="addObject",W="updateObject",R="partialUpdateObject",E="partialUpdateObjectNoCreate",C="deleteObject",$=e=>({...N(e),deleteObjects(e,t){const s=e.map(e=>({objectID:e}));return this.chunk(s,C,t)}}),H=e=>({...e,getSettings(e){const t=c(void 0!==e?e:{});return t.queryParameters.getVersion="2",this.transporter.read({method:g,path:n("1/indexes/%s/settings",this.indexName)},t)}});const J=e=>({...e,search(e,t){return this.transporter.read({method:b,path:n("1/indexes/%s/query",this.indexName),data:{query:e},cacheable:!0},t)}}),U=e=>({...N(e),partialUpdateObjects(e,t){const s=l(t,"createIfNotExists",!1)?R:E;return this.chunk(e,s,t)}});const F=e=>({...N(e),saveObjects(e,t){const s=l(t,"autoGenerateObjectIDIfNotExist",!1)?A:W;return s===W&&function(e){e.forEach(e=>{if(!e.hasOwnProperty("objectID"))throw function(e){return{name:"MissingObjectIDError",message:e}}(". All objects must have an unique objectID (like a primary key) to be valid. Algolia is also able to generate objectIDs automatically but *it's not recommended*. To do it, use `saveObjects(objects, {'autoGenerateObjectIDIfNotExist': true})`.")})}(e),this.chunk(e,s,t)}});const Q=e=>({...v(e),saveRules(e,t){const s=c(t);return!0===l(t,"clearExistingRules",!1)&&(s.queryParameters.clearExistingRules="true"),w(this.transporter.write({method:b,path:n("1/indexes/%s/rules/batch",this.indexName),data:e},s)).onWait((e,t)=>this.waitTask(e.taskID,t))}}),B=e=>({...v(e),saveSynonyms(e,t){const s=l(t,"forwardToReplicas",void 0),r=l(t,"replaceExistingSynonyms",void 0),a=c(t);return!0===s&&(a.queryParameters.forwardToReplicas="1"),!0===r&&(a.queryParameters.replaceExistingSynonyms="1"),w(this.transporter.write({method:b,path:n("1/indexes/%s/synonyms/batch",this.indexName),data:e},a)).onWait((e,t)=>this.waitTask(e.taskID,t))}}),M={searchClient:[e=>({...k(e),multipleBatch(e,t){return w(this.transporter.write({method:b,path:"1/indexes/*/batch",data:{requests:e}},t)).onWait((e,t)=>Promise.all(Object.keys(e.taskID).map(s=>this.initIndex(s,{methods:[v]}).waitTask(e.taskID[s],t))))}}),e=>({...e,multipleGetObjects(e,t){return this.transporter.read({method:b,path:"1/indexes/*/objects",data:{requests:e}},t)}}),e=>({...e,multipleQueries(e,t){const s=e.map(e=>({...e,params:i(e.params)}));return this.transporter.read({method:b,path:"1/indexes/*/queries",data:{requests:s},cacheable:!0},t)},search(e,t){return this.multipleQueries(e,t)}}),O,e=>({...O(e),copySettings(e,t,s){return this.copyIndex(e,t,{...void 0===s?{}:s,scope:[j]})}}),e=>({...O(e),copySynonyms(e,t,s){return this.copyIndex(e,t,{...void 0===s?{}:s,scope:[P]})}}),e=>({...k(e),moveIndex(e,t,s){return w(this.transporter.write({method:b,path:n("1/indexes/%s/operation",e),data:{operation:"move",destination:t}},s)).onWait((t,s)=>this.initIndex(e,{methods:[v]}).waitTask(t.taskID,s))}}),e=>({...e,getPersonalizationStrategy(e){return this.transporter.read({method:g,path:"1/recommendation/personalization/strategy"},e)}}),e=>({...e,setPersonalizationStrategy(e,t){return this.transporter.write({method:b,path:"1/recommendation/personalization/strategy",data:e},t)}}),e=>({...e,listIndices(e){return this.transporter.read({method:g,path:"1/indexes"},e)}}),e=>({...e,getLogs(e){const t=l(e,"length",10),s=l(e,"offset",0),r=l(e,"type","all"),a=c(e);return a.queryParameters.type=r,a.queryParameters.length=t,a.queryParameters.offset=s,this.transporter.read({method:g,path:"1/logs"},a)}}),e=>({...e,listClusters(e){return this.transporter.read({method:g,path:"1/clusters"},e)}}),e=>({...e,multipleSearchForFacetValues(e,t){return Promise.all(e.map(e=>{const s=Object.assign({},e.params),r=s.facetName,a=s.facetQuery;return delete s.facetName,delete s.facetQuery,k(this).initIndex(e.indexName,{methods:[D]}).searchForFacetValues(r,a,{...t,...s})}))},searchForFacetValues(e,t){return this.multipleSearchForFacetValues(e,t)}})],searchIndex:[N,e=>({...v(e),delete(e){return w(this.transporter.write({method:y,path:n("1/indexes/%s",this.indexName)},e)).onWait((e,t)=>this.waitTask(e.taskID,t))}}),e=>({...e,getObject(e,t){return this.transporter.read({method:g,path:n("1/indexes/%s/%s",this.indexName,e)},t)}}),e=>({...e,getObjects(e,t){const s=e.map(e=>({indexName:this.indexName,objectID:e,attributesToRetrieve:l(t,"attributesToRetrieve","*")}));return this.transporter.read({method:b,path:"1/indexes/*/objects",data:{requests:s}},t)}}),e=>({...F(e),saveObject(e,t){return w(this.saveObjects([e],t).then(e=>({objectID:e[0].objectIDs[0],taskID:e[0].taskID}))).onWait((e,t)=>this.waitTask(e.taskID,t))}}),F,J,D,v,e=>({...v(e),setSettings(e,t){return w(this.transporter.write({method:f,path:n("1/indexes/%s/settings",this.indexName),data:e},t)).onWait((e,t)=>this.waitTask(e.taskID,t))}}),H,e=>({...U(e),partialUpdateObject(e,t){return w(this.partialUpdateObjects([e],t).then(e=>({objectID:e[0].objectIDs[0],taskID:e[0].taskID}))).onWait((e,t)=>this.waitTask(e.taskID,t))}}),U,e=>({...$(e),deleteObject(e,t){return w(this.deleteObjects([e],t).then(e=>({taskID:e[0].taskID}))).onWait((e,t)=>this.waitTask(e.taskID,t))}}),$,e=>({...v(e),deleteBy(e,t){return w(this.transporter.write({method:b,path:n("1/indexes/%s/deleteByQuery",this.indexName),data:e},t)).onWait((e,t)=>this.waitTask(e.taskID,t))}}),e=>({...v(e),clearObjects(e){return w(this.transporter.write({method:b,path:n("1/indexes/%s/clear",this.indexName)},e)).onWait((e,t)=>this.waitTask(e.taskID,t))}}),e=>({...e,browseObjects(e){return T({...e,shouldStop:e=>void 0===e.cursor,request:t=>this.transporter.read({method:b,path:n("1/indexes/%s/browse",this.indexName),data:t},e)})}}),e=>({...e,getObjectPosition(e,t){for(const[s,r]of Object.entries(e.hits))if(r.objectID===t)return parseInt(s,10);return-1}}),e=>({...J(e),findObject(e,t){const s=l(t,"paginate",!0),r=l(t,"query","");let a=0;const n=()=>this.search(r,{...t,page:a}).then(t=>{for(const[s,r]of Object.entries(t.hits))if(e(r))return{object:r,position:parseInt(s,10),page:a};if(a++,!s||a>=t.nbPages)throw{name:"ObjectNotFoundError",message:"Object not found."};return n()});return n()}}),e=>({...H(e),exists(e){return this.getSettings(e).then(()=>!0).catch(e=>{if(404!==e.status)throw e;return!1})}}),e=>({...B(e),saveSynonym(e,t){return this.saveSynonyms([e],t)}}),B,e=>({...e,getSynonym(e,t){return this.transporter.read({method:g,path:n("1/indexes/%s/synonyms/%s",this.indexName,e)},t)}}),S,e=>({...S(e),browseSynonyms(e){const t={hitsPerPage:1e3,...e};return T({...t,shouldStop:e=>e.hits.length<t.hitsPerPage,request:t=>this.searchSynonyms("",{...e,...t}).then(e=>({...e,hits:e.hits.map(e=>(delete e._highlightResult,e))}))})}}),e=>({...v(e),deleteSynonym(e,t){return w(this.transporter.write({method:y,path:n("1/indexes/%s/synonyms/%s",this.indexName,e)},t)).onWait((e,t)=>this.waitTask(e.taskID,t))}}),e=>({...v(e),clearSynonyms(e){return w(this.transporter.write({method:b,path:n("1/indexes/%s/synonyms/clear",this.indexName)},e)).onWait((e,t)=>this.waitTask(e.taskID,t))}}),e=>({...v(e),replaceAllObjects(e,t){const s=(e,t,s,r)=>w(this.transporter.write({method:b,path:n("1/indexes/%s/operation",e),data:{operation:s,destination:t}},r)).onWait((e,t)=>this.waitTask(e.taskID,t)),r=l(t,"safe",!1),a=Math.random().toString(36).substring(7),i=F({transporter:this.transporter,indexName:`${this.indexName}_tmp_${a}`});let o=[];const h=s(this.indexName,i.indexName,"copy",{...t,scope:["settings","synonyms","rules"]});return o.push(h),w((r?h.wait(t):h).then(()=>{const s=i.saveObjects(e,t);return o.push(s),r?s.wait(t):s}).then(()=>{const e=s(i.indexName,this.indexName,"move",t);return o.push(e),r?e.wait(t):e}).then(()=>Promise.resolve())).onWait((e,t)=>Promise.all(o.map(e=>e.wait(t))))}}),e=>({...B(e),replaceAllSynonyms(e,t){return this.saveSynonyms(e,{...void 0===t?{}:t,replaceExistingSynonyms:!0})}}),q,e=>({...e,getRule(e,t){return this.transporter.read({method:g,path:n("1/indexes/%s/rules/%s",this.indexName,e)},t)}}),e=>({...v(e),deleteRule(e,t){return w(this.transporter.write({method:y,path:n("1/indexes/%s/rules/%s",this.indexName,e)},t)).onWait((e,t)=>this.waitTask(e.taskID,t))}}),e=>({...v(e),saveRule(e,t){return w(this.transporter.write({method:f,path:n("1/indexes/%s/rules/%s",this.indexName,e.objectID),data:e},t)).onWait((e,t)=>this.waitTask(e.taskID,t))}}),Q,e=>({...Q(e),replaceAllRules(e,t){return this.saveRules(e,{...t,clearExistingRules:!0})}}),e=>({...q(e),browseRules(e){const t={hitsPerPage:1e3,...e};return T({...t,shouldStop:e=>e.hits.length<t.hitsPerPage,request:t=>this.searchRules("",{...e,...t}).then(e=>({...e,hits:e.hits.map(e=>(delete e._highlightResult,e))}))})}}),e=>({...v(e),clearRules(e){return w(this.transporter.write({method:b,path:n("1/indexes/%s/rules/clear",this.indexName)},e)).onWait((e,t)=>this.waitTask(e.taskID,t))}})],analyticsClient:[e=>({...e,addABTest(e,t){return this.transporter.write({method:b,path:"2/abtests",data:e},t)}}),e=>({...e,getABTest(e,t){return this.transporter.read({method:g,path:n("2/abtests/%s",e)},t)}}),e=>({...e,getABTests(e){return this.transporter.read({method:g,path:"2/abtests"},e)}}),e=>({...e,stopABTest(e,t){return this.transporter.write({method:b,path:n("2/abtests/%s/stop",e)},t)}}),e=>({...e,deleteABTest(e,t){return this.transporter.write({method:y,path:n("2/abtests/%s",e)},t)}})]},L=t=>{return{...x({...t,methods:M.searchClient}),initIndex(e){return k(this).initIndex(e,{methods:M.searchIndex})},initAnalytics:s=>(t=>{const s=void 0!==t.region?t.region:"us",a=e.createAuth(r.WithinHeaders,t.appId,t.apiKey),n=p(t);return n.setHosts([{url:`analytics.${s}.algolia.com`,accept:m.Any}]),n.addHeaders({...a.headers(),"content-type":"application/json"}),n.addQueryParameters(a.queryParameters()),e.compose({transporter:n},t)})({...t,region:s,methods:M.analyticsClient})}};function V(e,r,a={}){return L({appId:e,apiKey:r,timeouts:{read:1,write:30},requester:{send:e=>new Promise(t=>{const s=new XMLHttpRequest;s.open(e.method,e.url,!0),Object.keys(e.headers).forEach(t=>s.setRequestHeader(t,e.headers[t]));const r=setTimeout(()=>{s.abort(),t({status:0,content:"",isTimedOut:!0})},1e3*e.timeout);s.onerror=()=>{0===s.status&&(clearTimeout(r),t({content:s.responseText||"Network request failed",status:s.status,isTimedOut:!1}))},s.onload=()=>{clearTimeout(r),t({content:s.responseText,status:s.status,isTimedOut:!1})},s.send(e.data)})},logger:(i=void 0===a.logLevel?s.Error:a.logLevel,{debug(e,t){s.Debug>=i&&console.debug(e,t)},info(e,t){s.Info>=i&&console.info(e,t)},error(e,t){console.error(e,t)}}),responsesCache:t(),requestsCache:t(),hostsCache:{get(e,t,s){const r=JSON.stringify(e),a=localStorage.getItem(r);if(null!==a)return Promise.resolve(JSON.parse(a));const n=t(),i=s&&s.miss||(()=>Promise.resolve());return n.then(e=>i(e)).then(()=>n)},set:(e,t)=>(localStorage.setItem(JSON.stringify(e),JSON.stringify(t)),Promise.resolve(t)),delete:e=>(localStorage.removeItem(JSON.stringify(e)),Promise.resolve()),clear:()=>(localStorage.clear(),Promise.resolve())},userAgent:(n="4.0.0-alpha.0",{value:`Algolia for JavaScript (${n})`,with(e){return this.value=`${this.value}; ${e.segment}`,void 0!==e.version&&(this.value+=` (${e.version})`),Object.assign({},this)}}).with({segment:"Browser"})});var n,i}return window.algoliasearch=V,V}));
